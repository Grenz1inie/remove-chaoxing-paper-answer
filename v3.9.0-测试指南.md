# v3.9.0 智能会话复用 - 测试指南

## 🎯 测试目标
验证自动会话复用功能是否按预期工作，确保超星页面和豆包页面之间的跨标签页通信正常。

## 🔧 功能概述
v3.9.0 实现了真正的自动会话复用：
- **首次使用**：自动保存网站分配的会话ID
- **后续使用**：自动打开上次的会话
- **跨标签页通信**：使用 `GM_addValueChangeListener` 实现实时通信
- **持久化存储**：会话ID保存到 IndexedDB

## 📋 测试步骤

### 测试场景1：首次使用（自动保存会话ID）

1. **准备**
   - 清空浏览器 IndexedDB 中的 `aiChatId` 配置（或使用隐私模式）
   - 打开超星学习通作业页面
   - 打开浏览器开发者工具（F12）查看控制台

2. **执行**
   - 点击任意题目右上角的 "🤖 问豆包" 按钮
   - 观察控制台输出（超星页面）：
     ```
     📖 从 IndexedDB 读取配置:
       会话ID: (空，将新建标签页并自动保存分配的ID)
     🔄 未配置会话ID，将自动保存网站分配的ID
     ```
   - 自动打开豆包AI新标签页
   - 观察控制台输出（豆包页面）：
     ```
     🚀 页面加载完成，提取当前会话ID: 32928786432382466
     🔍 豆包页面检测到会话ID: 32928786432382466
     ✅ 检测到自动保存标志，触发保存机制
     已自动保存分配的会话ID: 32928786432382466
     ```
   - 回到超星页面，观察控制台输出：
     ```
     ✅ 已自动保存会话ID: 32928786432382466
     💾 会话ID已持久化到 IndexedDB
     ```

3. **验证**
   - ✅ 豆包页面自动填充题目并发送
   - ✅ 超星页面控制台显示"已自动保存会话ID"
   - ✅ 打开控制面板 → AI提问管理，会话ID框显示刚保存的ID

### 测试场景2：后续使用（自动复用会话）

1. **准备**
   - 保持场景1中保存的会话ID
   - 关闭豆包AI标签页（测试浏览器是否复用）

2. **执行**
   - 点击另一道题目的 "🤖 问豆包" 按钮
   - 观察控制台输出（超星页面）：
     ```
     📖 从 IndexedDB 读取配置:
       会话ID: 32928786432382466
     目标URL: https://www.doubao.com/chat/32928786432382466
     ```
   - 打开的豆包页面URL应为 `https://www.doubao.com/chat/32928786432382466`

3. **验证**
   - ✅ 打开的是上次的会话，不是新建会话
   - ✅ 可以看到之前的对话历史
   - ✅ 新题目自动填充并发送到当前会话

### 测试场景3：手动更换会话ID

1. **准备**
   - 在豆包AI手动创建一个新会话
   - 复制新会话的URL，例如：`https://www.doubao.com/chat/99999999999999999`
   - 提取数字ID：`99999999999999999`

2. **执行**
   - 打开控制面板 → AI提问管理
   - 将 `99999999999999999` 粘贴到"豆包会话ID"输入框
   - 点击"💾 保存配置"
   - 点击任意题目的 "🤖 问豆包" 按钮

3. **验证**
   - ✅ 打开的是新配置的会话（99999999999999999）
   - ✅ 新题目自动填充并发送

### 测试场景4：URL变化监听

1. **准备**
   - 保持豆包AI标签页打开
   - 打开开发者工具查看控制台

2. **执行**
   - 在豆包AI页面手动创建新对话（点击"+"按钮）
   - 观察控制台输出：
     ```
     🔄 URL变化，检测到新会话ID: 12345678901234567
     🔍 豆包页面检测到会话ID: 12345678901234567
     ℹ️ 无需自动保存(已有配置或非首次)
     ```

3. **验证**
   - ✅ URL变化被正确监听
   - ✅ 新会话ID被提取并记录
   - ✅ 不会覆盖已配置的会话ID（因为 `doubao_auto_save_id` 为 false）

### 测试场景5：超时清理机制

1. **准备**
   - 清空 IndexedDB 中的 `aiChatId`
   - 准备计时器

2. **执行**
   - 点击 "🤖 问豆包" 按钮，但**不要**让豆包页面加载完成（立即关闭标签页或断网）
   - 等待 30 秒
   - 观察超星页面控制台，监听器应被自动清理

3. **验证**
   - ✅ 30秒后无错误抛出
   - ✅ 不会造成内存泄漏

## 🔍 调试信息说明

### 超星页面控制台关键信息
```
📖 从 IndexedDB 读取配置:          # 读取配置
  前缀配置: (空)
  后缀配置: (空)
  会话ID: 32928786432382466        # 当前保存的会话ID

🔄 未配置会话ID，将自动保存网站分配的ID   # 触发自动保存逻辑

✅ 已自动保存会话ID: 32928786432382466   # 保存成功
💾 会话ID已持久化到 IndexedDB           # 持久化完成
```

### 豆包页面控制台关键信息
```
🚀 页面加载完成，提取当前会话ID: 32928786432382466   # 页面加载时提取
🔍 豆包页面检测到会话ID: 32928786432382466          # 检测到ID
✅ 检测到自动保存标志，触发保存机制                   # 触发保存
已自动保存分配的会话ID: 32928786432382466           # 保存成功

🔄 URL变化，检测到新会话ID: 12345678901234567      # URL变化监听
ℹ️ 无需自动保存(已有配置或非首次)                    # 无需保存
```

## ✅ 测试通过标准
- ✅ 首次使用自动保存会话ID
- ✅ 后续使用自动复用已保存的会话
- ✅ 手动配置会话ID立即生效
- ✅ URL变化被正确监听
- ✅ 跨标签页通信正常工作
- ✅ IndexedDB持久化成功
- ✅ 30秒超时清理正常
- ✅ 无控制台错误

## 🐛 常见问题排查

### 问题1：会话ID未自动保存
- **检查**：豆包页面是否正常加载
- **检查**：控制台是否有错误信息
- **检查**：URL是否包含 `/chat/数字ID` 格式

### 问题2：打开的不是配置的会话
- **检查**：控制面板中的会话ID是否正确保存
- **检查**：IndexedDB中的 `aiChatId` 是否存在
- **执行**：清除浏览器缓存后重试

### 问题3：跨标签页通信失败
- **检查**：`GM_addValueChangeListener` 权限是否正确声明
- **检查**：Tampermonkey是否为最新版本
- **执行**：重启浏览器后重试

### 问题4：URL监听不生效
- **检查**：浏览器是否支持 `window.onurlchange`
- **备选**：现代浏览器（Chrome 102+、Edge 102+）均支持

## 📝 版本兼容性
- ✅ 向后兼容 v3.8.2 手动配置的会话ID
- ✅ 保留所有原有配置（前后缀、会话ID）
- ✅ 无需迁移数据，直接升级即可

## 🎉 测试完成
完成以上所有测试场景后，即可确认 v3.9.0 智能会话复用功能正常工作！
