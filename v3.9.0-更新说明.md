# v3.9.0 更新说明

## 🚀 核心更新：智能会话复用

### 🎯 解决的问题
- **v3.8.2 痛点**：需要手动复制粘贴会话ID，首次使用体验不佳
- **豆包限制**：频繁新建会话会触发豆包的会话上限
- **用户期望**：希望像使用原生应用一样，自动记住上次的对话

### ✨ 新功能特性

#### 1️⃣ 自动保存会话ID
- **首次使用**：点击"问豆包"后，脚本自动保存网站分配的会话ID
- **技术实现**：URL监听 + 跨标签页通信 + IndexedDB持久化
- **用户体验**：完全自动，无需任何手动操作

#### 2️⃣ 智能判断逻辑
```
如果已配置会话ID：
    ✅ 打开指定会话（复用配置）
否则：
    1️⃣ 打开新会话
    2️⃣ 等待页面加载
    3️⃣ 提取URL中的会话ID
    4️⃣ 自动保存到IndexedDB
    5️⃣ 下次使用自动复用
```

#### 3️⃣ 立即生效
- **保存后立即使用**：保存的会话ID下次点击"问豆包"立即生效
- **无需刷新页面**：配置实时同步到 IndexedDB

#### 4️⃣ 完全兼容
- **向后兼容**：保留 v3.8.2 的手动配置功能
- **无需迁移**：直接升级，已有配置继续有效
- **可选手动**：依然可以手动更换会话ID

### 🔧 技术亮点

#### API使用
- `GM_addValueChangeListener`：监听跨标签页数据变化
- `GM_removeValueChangeListener`：清理监听器，防止内存泄漏
- `window.onurlchange`：监听豆包页面URL变化
- `GM_setValue/GM_getValue`：跨域临时数据传递
- `IndexedDB`：持久化存储会话ID

#### 工作流程
```
超星页面                          豆包页面
   │                                 │
   ├─ 检查IndexedDB配置              │
   │  ├─ 有会话ID：打开指定会话      │
   │  └─ 无会话ID：                  │
   │      ├─ 打开新会话               │
   │      ├─ 设置自动保存标志         │
   │      └─ 监听保存事件             │
   │                                 ├─ 页面加载完成
   │                                 ├─ 提取URL中的会话ID
   │                                 ├─ 检查自动保存标志
   │                                 └─ 触发保存事件
   ├─ 收到保存事件                   │
   ├─ 保存到IndexedDB                │
   ├─ 清除监听器                     │
   └─ 完成                           └─ 完成
```

### 📋 使用说明

#### 场景1：首次使用（推荐）
1. 点击任意题目的 "🤖 问豆包" 按钮
2. 等待豆包页面加载（自动保存会话ID）
3. 完成！下次使用自动复用该会话

#### 场景2：手动指定会话（可选）
1. 在豆包AI创建新对话
2. 复制URL中的数字ID（如：`32898162890824194`）
3. 打开控制面板 → AI提问管理 → 豆包会话ID
4. 粘贴ID并保存
5. 下次点击"问豆包"使用新会话

#### 场景3：切换回自动模式
1. 打开控制面板 → AI提问管理
2. 清空"豆包会话ID"输入框
3. 保存配置
4. 下次点击"问豆包"会新建会话并自动保存

### 🐛 调试信息

#### 超星页面控制台
```javascript
📖 从 IndexedDB 读取配置:
  会话ID: (空，将新建标签页并自动保存分配的ID)
🔄 未配置会话ID，将自动保存网站分配的ID
✅ 已自动保存会话ID: 32928786432382466
💾 会话ID已持久化到 IndexedDB
```

#### 豆包页面控制台
```javascript
🚀 页面加载完成，提取当前会话ID: 32928786432382466
🔍 豆包页面检测到会话ID: 32928786432382466
✅ 检测到自动保存标志，触发保存机制
已自动保存分配的会话ID: 32928786432382466
```

### 🔍 常见问题

#### Q1：会话ID保存在哪里？
**A**：保存在浏览器的 IndexedDB 中，永久有效，清除浏览器数据会丢失。

#### Q2：可以手动更换会话吗？
**A**：可以！在控制面板 → AI提问管理 → 豆包会话ID 中手动配置。

#### Q3：自动保存会覆盖手动配置的会话ID吗？
**A**：不会！只有在**未配置**会话ID时才会自动保存。

#### Q4：如何清除已保存的会话ID？
**A**：在控制面板 → AI提问管理 → 豆包会话ID 中清空输入框并保存。

#### Q5：支持多个会话切换吗？
**A**：目前只支持保存一个会话ID，可以随时手动更换。

#### Q6：浏览器会自动聚焦已打开的标签页吗？
**A**：是的！利用浏览器的原生标签页管理机制，相同URL会自动聚焦。

### 📦 升级指南

#### 从 v3.8.2 升级
1. 直接安装 v3.9.0
2. 已配置的会话ID继续有效
3. 首次使用未配置会话ID时，会自动保存新会话
4. 无需任何数据迁移

#### 版本对比
| 功能 | v3.8.2 | v3.9.0 |
|------|--------|--------|
| 手动配置会话ID | ✅ | ✅ |
| 自动保存会话ID | ❌ | ✅ |
| URL监听 | ❌ | ✅ |
| 跨标签页通信 | ❌ | ✅ |
| 持久化存储 | ✅ | ✅ |
| 向后兼容 | - | ✅ |

### 🎉 总结
v3.9.0 实现了真正的自动会话复用，无需手动配置即可享受便捷的AI提问体验！

---

**开发者**：GitHub Copilot  
**发布日期**：2025年  
**技术支持**：查看 `v3.9.0-测试指南.md` 了解详细测试步骤
